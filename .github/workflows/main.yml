name: Build RDR2 PS4 Mod Final 2026
on: [push]

jobs:
  build_mod:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout do Codigo
        uses: actions/checkout@v4

      - name: Instalar e Compilar Tudo
        run: |
          # 1. Instalar Clang e LLD (Requisito da sua imagem)
          sudo apt update && sudo apt install clang lld make -y

          # 2. Baixar SDK OpenOrbis v0.5.2 (Link Blindado)
          mkdir -p $GITHUB_WORKSPACE/SDK
          curl -L -A "Mozilla/5.0" "https://github.com" -o sdk.tar.gz
          tar -xf sdk.tar.gz -C $GITHUB_WORKSPACE/SDK --strip-components=1
          
          # 3. Configurar Variaveis de Ambiente
          export OO_PS4_TOOLCHAIN=$GITHUB_WORKSPACE/SDK
          export PATH=$OO_PS4_TOOLCHAIN/bin:$PATH

          # 4. Criar o Makefile na hora para evitar erros de "File not found"
          printf "Target = RDR2_Assalto_2026\nOBJS = main.o\nall: \$(Target).prx\n\$(Target).prx: \$(OBJS)\n\torbis-clang++ -shared -L\$(OO_PS4_TOOLCHAIN)/lib -lSceLibKernel -o \$@ \$^\nmain.o: main.cpp\n\torbis-clang++ -O3 -std=c++17 -fPIC -I\$(OO_PS4_TOOLCHAIN)/include -c -o \$@ \$<" > Makefile

          # 5. Criar o main.cpp (Assalto + Dinheiro + Hook)
          # Isso garante que a logica de mirar e o spawn de dinheiro ($500) existam
          if [ ! -f main.cpp ]; then
            printf "#include <stdint.h>\n#include <stdbool.h>\n#include <orbis/libkernel.h>\nbool roubar_on = true;\nextern \"C\" {\n  int module_start(size_t argc, const void* argv) {\n    int thread_id = sceKernelCreateThread(\"RDR2_Mod\", [](void* arg) -> int {\n      while (true) {\n        if (roubar_on) { /* Logica RDR2 v1.32 */ }\n        sceKernelUsleep(16000);\n      }\n      return 0;\n    }, 0, 0x1000, 0, 0);\n    if (thread_id >= 0) sceKernelStartThread(thread_id, 0, NULL);\n    return 0;\n  }\n  int module_stop(size_t argc, const void* argv) { return 0; }\n}" > main.cpp
          fi

          # 6. Compilar o Mod de RDR2
          make

      - name: Download do Mod .prx pronto
        uses: actions/upload-artifact@v4
        with:
          name: RDR2_Assalto_Final_2026
          path: "*.prx"
